# AWS MKS cluster Terraform module
Terraform module for AWS MKS cluster creation

## Usage

### Provisioned cluster
```hcl
module "kinesis_firehouse" {
  source  = "data-platform-hq/mks-cluster/aws"
  version = "~> 1.0"
  
  tags = {
    ENV : "Development"
  }
  
  cluster_name                                  = "provisioned-mks-cluster1"
  cluster_type                                  = "provisioned"
  client_subnets                                = ["subnet-12345678", "subnet-87654321", "subnet-12348765"]
  kafka_version                                 = "2.8.1"
  number_of_broker_nodes                        = 3
  instance_type                                 = "kafka.t3.small"
  client_authentication_sasl_enabled            = true
  client_authentication_sasl_iam                = true
  client_authentication_unauthenticated_enabled = true
  msk_configuration_enabled                     = true
  mks_configuration_server_properties = {
    "auto.create.topics.enable" : true
    "delete.topic.enable" : true
  }
  encryption_enabled = true
  encryption_config = {
    encryption_in_transit_enabled = true
  }
  open_monitoring_enabled = true
  open_monitoring_config = {
    jmx_exporter_enabled_in_broker  = true
    node_exporter_enabled_in_broker = true
  }

  logging_enabled = true
  logging_s3 = {
    enabled = true
    bucket  = "bucket1"
  }
}
```

### Serverless cluster
```hcl
module "kinesis_firehouse" {
  source  = "data-platform-hq/mks-cluster/aws"
  version = "~> 1.0"
  
  tags = {
    ENV : "Development"
  }
  
  cluster_name                           = "serverless-mks-cluster1"
  cluster_type                           = "serverless"
  client_subnets                         = ["subnet-12345678", "subnet-87654321", "subnet-12348765"]
  client_authentication_sasl_iam_enabled = true
}
```

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name                                                                        | Version  |
|-----------------------------------------------------------------------------|----------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform)   | >= 1.0   |
| <a name="requirement_aws"></a> [aws](#requirement\_aws)                     | >= 5.1.0 |

## Providers

| Name                                                | Version  |
|-----------------------------------------------------|----------|
| <a name="provider_aws"></a> [aws](#provider\_aws)   | >= 5.1.0 |

##[README.md](README.md) Modules

No modules.

## Resources

| Name                                                                                                                                              | Type        |
|---------------------------------------------------------------------------------------------------------------------------------------------------|-------------|
| [aws_msk_cluster.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/msk_cluster)                                   | resource    |
| [aws_msk_configuration.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/msk_configuration)                       | resource    |
| [aws_msk_serverless_cluster.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/msk_serverless_cluster)             | resource    |
| [aws_msk_scram_secret_association.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/msk_scram_secret_association) | resource    |
| [aws_subnet.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/subnet)                                          | data source |
| [aws_security_group.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group)                             | resource    |
| [aws_security_group_rule.*](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group_rule)                      | resource    |

## Inputs

| Name                                                                                                                                                                                                     | Description                                                                                                                                                                                                                                                        | Type                                                                                                                                                                                                                                                                                                | Default |                 Required                  |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------|:-----------------------------------------:|
| <a name="input_create"></a> [create](#input\_create)                                                                                                                                                     | Controls if resources should be created (affects nearly all resources)                                                                                                                                                                                             | `bool`                                                                                                                                                                                                                                                                                              | `true`  |                    no                     |
| <a name="input_tags"></a> [tags](#input\_tags)                                                                                                                                                           | A map of tags to add to all resources                                                                                                                                                                                                                              | `map(string)`                                                                                                                                                                                                                                                                                       | `{}`    |                    no                     |
| <a name="input_cluster_name"></a> [name](#input\_cluster\_name)                                                                                                                                          | Name of the MSK cluster                                                                                                                                                                                                                                            | `string`                                                                                                                                                                                                                                                                                            | n/a     |                    yes                    |
| <a name="input_cluster_type"></a> [cluster\_type](#input\_cluster\_type)                                                                                                                                 | Type of MSK cluster. Possible values: provisioned and serverless                                                                                                                                                                                                   | `string`                                                                                                                                                                                                                                                                                            | n/a     |                    yes                    |
| <a name="input_client_subnets"></a> [client\_subnets](#input\_client\_subnets)                                                                                                                           | A list of subnets to connect to in client VPC                                                                                                                                                                                                                      | `list(string)`                                                                                                                                                                                                                                                                                      | n/a     |                    yes                    |
| <a name="input_additional_security_groups"></a> [additional\_security\_groups](#input\_additional\_security\_groups)                                                                                     | An additional list of the security groups to associate with the elastic network interfaces to control who can communicate with the cluster                                                                                                                         | `list(string)`                                                                                                                                                                                                                                                                                      | `[]`    |                    no                     |
| <a name="input_secret_association_enabled"></a> [secret\_association\_enabled](#input\_secret\_association\_enabled)                                                                                     | Whether to enable SCRAM secrets association                                                                                                                                                                                                                        | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_esecret_arn_list"></a> [secret\_arn\_list](#input\_secret\_arn\_list)                                                                                                                     | List of AWS Secrets Manager secret ARNs                                                                                                                                                                                                                            | `list(string)`                                                                                                                                                                                                                                                                                      | []      |                    no                     |
| <a name="input_client_authentication_sasl_iam_enabled"></a> [client\_authentication\_sasl\_iam\_enabled](#input\_client\_authentication\_sasl\_iam\_enabled)                                             | Whether SASL/IAM authentication is enabled. _Only applicable when cluster_type is serverless_                                                                                                                                                                      | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_kafka_version"></a> [kafka\_version](#input\_kafka\_version)                                                                                                                              | Specify the desired Kafka software version. _Only applicable when cluster_type is provisioned_                                                                                                                                                                     | `string`                                                                                                                                                                                                                                                                                            | `""`    | yes (only if cluster_type is provisioned) |
| <a name="input_number_of_broker_nodes"></a> [number\_of\_broker\_nodes](#input\_number\_of\_broker\_nodes)                                                                                               | The desired total number of broker nodes in the kafka cluster. It must be a multiple of the number of specified client subnets. _Only applicable when cluster_type is provisioned_                                                                                 | `number`                                                                                                                                                                                                                                                                                            | `null`  | yes (only if cluster_type is provisioned) |
| <a name="input_instance_type"></a> [instance\_type](#input\_instance\_type)                                                                                                                              | Specify the instance type to use for the kafka brokers. _Only applicable when cluster_type is provisioned_                                                                                                                                                         | `string`                                                                                                                                                                                                                                                                                            | `""`    | yes (only if cluster_type is provisioned) |
| <a name="input_az_distribution_enabled"></a> [az\_distribution\_enabled](#input\_az\_distribution\_enabled)                                                                                              | Whether to enable the distribution of broker nodes across availability zones. _Only applicable when cluster_type is provisioned_                                                                                                                                   | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_public_access_type_enabled"></a> [public\_access\_type\_enabled](#input\_public\_access\_type\_enabled)                                                                                   | Whether to enable public access. If enabled, will set public_access.type to SERVICE_PROVIDED_EIPS. _Only applicable when cluster_type is provisioned_                                                                                                              | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_ebs_storage_info_enabled"></a> [ebs\_storage\_info\_enabled](#input\_ebs\_storage\_info\_enabled)                                                                                         | Whether to enable configuration for storage volumes attached to MSK broker nodes. _Only applicable when cluster_type is provisioned_                                                                                                                               | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_ebs_storage_info"></a> [ebs\_storage\_info](#input\_ebs\_storage\_info)                                                                                                                   | A block that contains EBS volume information. _Only applicable when cluster_type is provisioned_                                                                                                                                                                   | <pre>object({<br/>  provisioned_throughput_enabled           = optional(bool, false)<br/>  provisioned_throughput_volume_throughput = optional(number, null)<br/>  volume_size                              = optional(number, null)<br/>})</pre>                                                   | `{}`    |                    no                     |
| <a name="input_client_authentication_sasl_enabled"></a> [client\_authentication\_sasl\_enabled](#input\_client\_authentication\_sasl\_enabled)                                                           | Whether to enable SASL client authentication. _Only applicable when cluster_type is provisioned_                                                                                                                                                                   | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_client_authentication_sasl_iam"></a> [client\_authentication\_sasl\_iam](#input\_client\_authentication\_sasl\_iam)                                                                       | Enables IAM client authentication. _Only applicable when cluster_type is provisioned_                                                                                                                                                                              | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_client_authentication_sasl_scram"></a> [client\_authentication\_sasl\_scram](#input\_client\_authentication\_sasl\_scram)                                                                 | Enables SCRAM client authentication via AWS Secrets Manager. _Only applicable when cluster_type is provisioned_                                                                                                                                                    | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_client_authentication_tls_enabled"></a> [client\_authentication\_tls\_enabled](#input\_client\_authentication\_tls\_enabled)                                                              | Whether to enable TLS client authentication. _Only applicable when cluster_type is provisioned_                                                                                                                                                                    | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_client_authentication_tls_certificate_authority_arns"></a> [client\_authentication\_tls\_certificate\_authority\_arns](#input\_client\_authentication\_tls\_certificate\_authority\_arns) | List of ACM Certificate Authority Amazon Resource Names. _Only applicable when cluster_type is provisioned_                                                                                                                                                        | `list(string)`                                                                                                                                                                                                                                                                                      | `[]`    |                    no                     |
| <a name="input_client_authentication_unauthenticated_enabled"></a> [client\_authentication\_unauthenticated\_enabled](#input\_client\_authentication\_unauthenticated\_enabled)                          | Whether to enable unauthenticated access. _Only applicable when cluster_type is provisioned_                                                                                                                                                                       | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_msk_configuration_enabled"></a> [msk\_configuration\_enabled](#input\_msk\_configuration\_enabled)                                                                                        | Whether to create MSK configuration. _Only applicable when cluster_type is provisioned_                                                                                                                                                                            | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_mks_configuration_server_properties"></a> [mks\_configuration\_server\_properties](#input\_mks\_configuration\_server\_properties)                                                        | A map of the contents of the server.properties file. Supported properties are documented in the [MSK Developer Guide](https://docs.aws.amazon.com/msk/latest/developerguide/msk-configuration-properties.html). _Only applicable when cluster_type is provisioned_ | `map(string)`                                                                                                                                                                                                                                                                                       | `{}`    |                    no                     |
| <a name="input_encryption_enabled"></a> [encryption\_enabled](#input\_encryption\_enabled)                                                                                                               | Whether to enable encryption. _Only applicable when cluster_type is provisioned_                                                                                                                                                                                   | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_encryption_config"></a> [encryption\_config](#input\_encryption\_config)                                                                                                                  | Encryption configuration. _Only applicable when cluster_type is provisioned_                                                                                                                                                                                       | <pre>object({<br/>  encryption_in_transit_enabled       = optional(bool, false)<br/>  encryption_in_transit_client_broker = optional(string, null)<br/>  encryption_in_transit_in_cluster    = optional(bool, null)<br/>  encryption_at_rest_kms_key_arn      = optional(string, null)<br/>})</pre> | `{}`    |                    no                     |
| <a name="input_enhanced_monitoring"></a> [enhanced\_monitoring](#input\_enhanced\_monitoring)                                                                                                            | Specify the desired enhanced MSK CloudWatch monitoring level. _Only applicable when cluster_type is provisioned_                                                                                                                                                   | `string`                                                                                                                                                                                                                                                                                            | `null`  |                    no                     |
| <a name="input_open_monitoring_enabled"></a> [open\_monitoring\_enabled](#input\_open\_monitoring\_enabled)                                                                                              | Whether to enable JMX and Node monitoring for the MSK cluster. _Only applicable when cluster_type is provisioned_                                                                                                                                                  | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_open_monitoring_config"></a> [open\_monitoring\_config](#input\_open\_monitoring\_config)                                                                                                 | Configuration for JMX and Node monitoring for the MSK cluster. _Only applicable when cluster_type is provisioned_                                                                                                                                                  | <pre>object({<br/>  jmx_exporter_enabled_in_broker  = optional(bool, false)<br/>  node_exporter_enabled_in_broker = optional(bool, false)<br/>})</pre>                                                                                                                                              | `{}`    |                    no                     |
| <a name="input_logging_enabled"></a> [logging\_enabled](#input\_logging\_enabled)                                                                                                                        | Whether to enable Broker Logs. _Only applicable when cluster_type is provisioned_                                                                                                                                                                                  | `bool`                                                                                                                                                                                                                                                                                              | `false` |                    no                     |
| <a name="input_logging_cloudwatch"></a> [logging\_cloudwatch](#input\_logging\_cloudwatch)                                                                                                               | Configuration for streaming broker logs to Cloudwatch Logs. _Only applicable when cluster_type is provisioned_                                                                                                                                                     | <pre>object({<br/>  enabled   = optional(bool, false)<br/>  log_group = optional(string, null)<br/>})</pre>                                                                                                                                                                                         | `{}`    |                    no                     |
| <a name="input_logging_firehose"></a> [logging\_firehose](#input\_logging\_firehose)                                                                                                                     | Configuration for streaming broker logs to Kinesis Data Firehose. _Only applicable when cluster_type is provisioned_                                                                                                                                               | <pre>object({<br/>  enabled         = optional(bool, false)<br/>  delivery_stream = optional(string, null)<br/>})</pre>                                                                                                                                                                             | `{}`    |                    no                     |
| <a name="input_logging_s3"></a> [logging\_s3](#input\_logging\_s3)                                                                                                                                       | Configuration for streaming broker logs to S3. _Only applicable when cluster_type is provisioned_                                                                                                                                                                  | <pre>object({<br/>  enabled = optional(bool, false)<br/>  bucket  = optional(string, null)<br/>  prefix  = optional(string, null)<br/>})</pre>                                                                                                                                                      | `{}`    |                    no                     |

## Outputs

| Name                                                                                                                                                  | Description                                                                                                                                                                          |
|-------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <a name="output_arn"></a> [arn](#output\_arn)                                                                                                         | Amazon Resource Name (ARN) of the MSK cluster                                                                                                                                        |
| <a name="output_bootstrap_brokers"></a> [bootstrap\_brokers](#output\_bootstrap\_brokers)                                                             | Comma separated list of one or more hostname:port pairs of kafka brokers suitable to bootstrap connectivity to the kafka cluster. _Only applicable when cluster_type is provisioned_ |
| <a name="output_bootstrap_brokers_public_sasl_iam"></a> [bootstrap\_brokers\_public\_sasl\_iam](#output\_bootstrap\_brokers\_public\_sasl\_iam)       | One or more DNS names (or IP addresses) and SASL IAM port pairs. _Only applicable when cluster_type is provisioned_                                                                  |
| <a name="output_bootstrap_brokers_public_sasl_scram"></a> [bootstrap\_brokers\_public\_sasl\_scram](#output\_bootstrap\_brokers\_public\_sasl\_scram) | One or more DNS names (or IP addresses) and SASL SCRAM port pairs. _Only applicable when cluster_type is provisioned_                                                                |
| <a name="output_bootstrap_brokers_public_tls"></a> [bootstrap\_brokers\_public\_tls](#output\_bootstrap\_brokers\_public\_tls)                        | One or more DNS names (or IP addresses) and TLS port pairs. _Only applicable when cluster_type is provisioned_                                                                       |
| <a name="output_bootstrap_brokers_sasl_iam"></a> [bootstrap\_brokers\_sasl\_iam](#output\_bootstrap\_brokers\_sasl\_iam)                              | One or more DNS names (or IP addresses) and SASL IAM port pairs. _Only applicable when cluster_type is provisioned_                                                                  |
| <a name="output_bootstrap_brokers_sasl_scram"></a> [bootstrap\_brokers\_sasl\_scram](#output\_bootstrap\_brokers\_sasl\_scram)                        | One or more DNS names (or IP addresses) and SASL SCRAM port pairs. _Only applicable when cluster_type is provisioned_                                                                |
| <a name="output_bootstrap_brokers_tls"></a> [bootstrap\_brokers\_tls](#output\_bootstrap\_brokers\_tls)                                               | One or more DNS names (or IP addresses) and TLS port pairs. _Only applicable when cluster_type is provisioned_                                                                       |
| <a name="output_current_version"></a> [current\_version](#output\_current\_version)                                                                   | Current version of the MSK Cluster used for updates. _Only applicable when cluster_type is provisioned_                                                                              |
| <a name="output_zookeeper_connect_string"></a> [zookeeper\_connect\_string](#output\_zookeeper\_connect\_string)                                      | A comma separated list of one or more hostname:port pairs to use to connect to the Apache Zookeeper cluster. _Only applicable when cluster_type is provisioned_                      |
<!-- END_TF_DOCS -->

## License

Apache 2 Licensed. For more information please see [LICENSE](https://github.com/data-platform-hq/terraform-azurerm-linux-web-app/tree/main/LICENSE)
